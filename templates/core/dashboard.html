{% extends 'base.html' %}
{% block title %}Dashboard - MITS Cloud{% endblock %}
{% block content %}
<!-- Enhanced Search Bar -->
<div class="bg-gradient-to-r from-slate-50 to-white border border-slate-200 rounded-2xl shadow-lg mb-8 overflow-hidden">
  <div class="p-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-slate-900">Search Files & Folders</h2>
        <p class="text-sm text-slate-600">Find your files quickly across all sessions and departments</p>
      </div>
    </div>
    
    <div class="flex gap-3">
      <div class="flex-1 relative">
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
          <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
        <input type="text" id="search-input" placeholder="Search files, folders, or descriptions..." 
               class="w-full border-2 border-slate-200 rounded-xl pl-12 pr-4 py-3 text-slate-900 placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white shadow-sm">
      </div>
      <button onclick="performSearch()" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-8 py-3 rounded-xl hover:from-blue-700 hover:to-blue-800 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center gap-2 font-medium">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        Search
      </button>
    </div>
    
    <div id="search-results" class="mt-6 hidden">
      <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
          <h3 class="font-semibold text-slate-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Search Results
          </h3>
        </div>
        <div id="search-results-content" class="p-6 space-y-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Session Info -->
{% if active_session %}
<div class="bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-2xl shadow-lg mb-8 overflow-hidden">
  <div class="p-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center">
          <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
        </div>
        <div>
          <h2 class="text-lg font-semibold text-slate-900">Current Active Session</h2>
          <div class="flex items-center gap-3 mt-1">
            <span class="text-base font-medium text-slate-800">{{ active_session.name }}</span>
            {% if is_using_override %}
            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800 border border-purple-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
              </svg>
              Faculty Override
            </span>
            {% else %}
            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 border border-green-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Global Active
            </span>
            {% endif %}
          </div>
        </div>
      </div>
      
      {% if is_using_override %}
      <div class="flex items-center gap-2 px-4 py-2 bg-purple-100 rounded-xl border border-purple-200">
        <div class="w-3 h-3 bg-purple-500 rounded-full animate-pulse"></div>
        <span class="text-sm font-medium text-purple-800">Override Active</span>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

<div class="grid md:grid-cols-3 gap-6">
  <!-- Enhanced Upload Section -->
  <div class="md:col-span-1 bg-white rounded-2xl shadow-xl border border-slate-200 upload-zone overflow-hidden">
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
        </div>
        <div>
          <h2 class="text-xl font-semibold text-white">Upload Files</h2>
          <p class="text-blue-100 text-sm">Drag & drop or use the form below</p>
        </div>
      </div>
    </div>
    
    <div class="p-6">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4 mb-6">
        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div>
            <h3 class="text-sm font-medium text-blue-900 mb-1">Quick Upload Tips</h3>
            <p class="text-sm text-blue-700">Drag and drop files directly onto this area or use the form below. You can upload individual files or entire folders.</p>
          </div>
        </div>
      </div>
    <form id="upload-form" class="space-y-5">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">Session</label>
        <select id="session" class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white" required>
          <option value="">Select Session</option>
        </select>
        {% if is_using_override %}
        <div class="mt-2">
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-lg text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
            </svg>
            Using Faculty Override Session
          </span>
        </div>
        {% endif %}
      </div>
      
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">Department</label>
        <select id="department" class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white" required>
          <option value="">Select Department</option>
        </select>
      </div>
      
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">
          Category 
          <span class="text-slate-500 font-normal">(optional)</span>
        </label>
        <select id="category" class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white">
          <option value="">No Category</option>
        </select>
      </div>
      
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">
          Parent Folder 
          <span class="text-slate-500 font-normal">(optional)</span>
        </label>
        <select id="parent" class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white">
          <option value="">Root</option>
        </select>
      </div>
      
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">
          New Folder Name 
          <span class="text-slate-500 font-normal">(optional)</span>
        </label>
        <input id="folder-name" class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-900 placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white" placeholder="Leave empty to upload file only" />
      </div>
      
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">
          Description 
          <span class="text-slate-500 font-normal">(optional)</span>
        </label>
        <textarea id="description" class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-900 placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white resize-none" rows="3"
          placeholder="File or folder description"></textarea>
      </div>
      
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-3">Visibility</label>
        <div class="space-y-3">
          <label class="flex items-center gap-3 p-3 border-2 border-slate-200 rounded-xl cursor-pointer hover:border-blue-300 transition-colors">
            <input id="visibility-public" type="radio" name="visibility" value="public" class="w-4 h-4 text-blue-600 focus:ring-blue-500" />
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              <div>
                <span class="text-sm font-medium text-slate-900">Public</span>
                <p class="text-xs text-slate-500">Visible on landing page</p>
              </div>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 border-2 border-slate-200 rounded-xl cursor-pointer hover:border-blue-300 transition-colors">
            <input id="visibility-private" type="radio" name="visibility" value="private" class="w-4 h-4 text-blue-600 focus:ring-blue-500" checked />
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
              </svg>
              <div>
                <span class="text-sm font-medium text-slate-900">Private</span>
                <p class="text-xs text-slate-500">Only you can see</p>
              </div>
            </div>
          </label>
        </div>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">Upload File</label>
          <div class="relative">
            <input id="file" type="file" class="w-full p-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer transition-colors" />
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
              <div class="text-center">
                <svg class="w-8 h-8 text-slate-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-xs text-slate-500">Click to select or drag & drop</p>
              </div>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-2">Supported: <span id="supported-extensions-list">Loading...</span></p>
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">
            Upload Folder 
            <span class="text-slate-500 font-normal">(optional)</span>
          </label>
          <div class="relative">
            <input id="folder-upload" type="file" class="w-full p-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer transition-colors" webkitdirectory directory multiple />
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
              <div class="text-center">
                <svg class="w-8 h-8 text-slate-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"></path>
                </svg>
                <p class="text-xs text-slate-500">Select entire folder with subfolders</p>
              </div>
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-2">Preserves folder structure and subfolders</p>
        </div>
      </div>
      
      <div class="flex gap-3 pt-2">
        <button type="button" id="create-folder-btn"
          class="flex-1 bg-gradient-to-r from-slate-600 to-slate-700 text-white rounded-xl py-3 px-4 hover:from-slate-700 hover:to-slate-800 focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition-all duration-200 font-medium flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Create Folder
        </button>
        <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl py-3 px-4 hover:from-blue-700 hover:to-blue-800 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 font-medium flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          Upload
        </button>
      </div>
    </form>
  </div>
  
  <!-- Enhanced My Drive Section -->
  <div class="md:col-span-2 bg-white p-0 rounded-xl shadow overflow-visible">
    <!-- Tabs -->
    <div class="border-b">
      <div class="flex">
        <button id="tab-all" onclick="switchTab('all')"
          class="px-4 py-3 text-sm font-medium border-b-2 border-primary text-primary bg-blue-50">
          All Files
        </button>
        <button id="tab-public" onclick="switchTab('public')"
          class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:text-slate-800">
          Public
        </button>
        <button id="tab-private" onclick="switchTab('private')"
          class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:text-slate-800">
          Private
        </button>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="px-4 py-3 border-b flex items-center justify-between bg-slate-50">
      <div class="flex items-center gap-2">
        <span class="text-lg font-semibold text-primary">My Drive</span>
        <span id="drive-breadcrumb" class="text-sm text-slate-500">/</span>
        <span id="current-tab-info" class="text-xs text-slate-500 bg-slate-200 px-2 py-1 rounded">All Files</span>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="openProfilePanel()" class="text-sm text-slate-700 hover:text-slate-900">Profile</button>
        <button id="drive-back-btn" onclick="driveGoUp()"
          class="text-sm text-slate-600 hover:text-slate-800 disabled:opacity-40 disabled:cursor-not-allowed">Back</button>
        <label class="text-sm cursor-pointer bg-primary text-white px-3 py-1.5 rounded hover:bg-blue-700">
          New
          <input type="file" class="hidden" onchange="driveUploadFile(event)" />
        </label>
        <label class="text-sm cursor-pointer bg-slate-700 text-white px-3 py-1.5 rounded hover:bg-slate-800">
          New folder upload
          <input type="file" class="hidden" webkitdirectory directory multiple onchange="driveUploadFolder(event)" />
        </label>
        <button onclick="refreshDrive()" class="text-sm text-primary hover:text-blue-700">Refresh</button>

      </div>
    </div>

    <!-- Grid View -->
    <div id="drive-grid" class="p-4 grid md:grid-cols-2 lg:grid-cols-3 gap-3 upload-area drive-grid">
      <div class="col-span-full text-center py-8 text-gray-500 hidden" id="empty-drop-zone">
        <div class="text-4xl mb-2">📁</div>
        <div class="text-lg font-medium">Drop files here to upload</div>
        <div class="text-sm">Or use the upload form on the left</div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Upload Progress UI -->
<div id="upload-progress" class="fixed bottom-4 right-4 lg:bottom-6 lg:right-6 hidden z-50 w-80 lg:w-96 bg-white border border-slate-200 rounded-2xl shadow-2xl overflow-hidden">
  <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
        <svg class="w-4 h-4 text-white animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
      </div>
      <div>
        <h3 class="text-white font-semibold">Uploading File</h3>
        <div class="text-blue-100 text-sm truncate" id="upload-progress-name">Uploading…</div>
      </div>
    </div>
  </div>
  
  <div class="p-6">
    <div class="mb-4">
      <div class="h-3 w-full bg-slate-200 rounded-full overflow-hidden">
        <div id="upload-progress-bar" class="h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full transition-all duration-300 ease-out" style="width:0%"></div>
      </div>
    </div>
    
    <div class="flex items-center justify-between text-sm">
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
          <span id="upload-progress-speed" class="text-slate-600 font-medium">0 KB/s</span>
        </div>
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          <span id="upload-progress-percent" class="text-slate-900 font-semibold">0%</span>
        </div>
      </div>
    </div>
  </div>
  
  <button class="w-full text-sm text-slate-500 border-t border-slate-200 px-6 py-3 hover:bg-slate-50 transition-colors flex items-center justify-center gap-2" onclick="hideProgress()">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
    Hide
  </button>
</div>

<!-- Enhanced Confirmation Modal -->
<div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all duration-300 scale-95 opacity-0" id="confirmation-modal-content">
    <div class="p-8">
      <div class="flex items-center justify-center mb-6">
        <div class="w-16 h-16 bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl flex items-center justify-center">
          <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
      </div>
      
      <div class="text-center">
        <h3 id="confirmation-title" class="text-xl font-semibold text-slate-900 mb-3">Confirm Action</h3>
        <p id="confirmation-message" class="text-slate-600 mb-8 leading-relaxed">
          Are you sure you want to perform this action? This cannot be undone.
        </p>
        
        <div class="flex gap-3 justify-center">
          <button id="confirmation-cancel"
            class="px-6 py-3 text-sm font-semibold text-slate-700 bg-slate-100 rounded-xl hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition-all duration-200 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancel
          </button>
          <button id="confirmation-confirm"
            class="px-6 py-3 text-sm font-semibold text-white bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 flex items-center gap-2 shadow-lg hover:shadow-xl">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Confirm
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Share Success Modal -->
<div id="share-success-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95 opacity-0" id="share-success-modal-content">
    <div class="p-8">
      <div class="flex items-center justify-center mb-6">
        <div class="w-16 h-16 bg-gradient-to-br from-green-100 to-emerald-100 rounded-2xl flex items-center justify-center">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
      </div>
      
      <div class="text-center">
        <h3 class="text-xl font-semibold text-slate-900 mb-3">Share Link Created!</h3>
        <p class="text-slate-600 mb-6">Your share link has been generated successfully. Copy it below to share with others.</p>
        
        <div class="mb-6">
          <label class="block text-sm font-semibold text-slate-700 mb-3">Share URL:</label>
          <div class="flex gap-2">
            <input id="share-url-input" type="text" readonly
              class="flex-1 px-4 py-3 border-2 border-slate-200 rounded-xl bg-slate-50 text-sm font-mono text-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Share URL will appear here">
            <button id="copy-share-url"
              class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-sm font-semibold transition-all duration-200 flex items-center gap-2 shadow-lg hover:shadow-xl">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
              Copy
            </button>
          </div>
        </div>
        
        <div class="flex justify-center">
          <button id="share-success-close"
            class="px-6 py-3 text-sm font-semibold text-slate-700 bg-slate-100 rounded-xl hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition-all duration-200 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Toast -->
<div id="toast" class="fixed bottom-6 right-6 lg:bottom-8 lg:right-8 hidden z-50 transform transition-all duration-300 translate-x-full opacity-0" id="toast-container">
  <div id="toast-inner" class="bg-red-600 text-white px-6 py-4 rounded-xl shadow-2xl border border-red-500 flex items-center gap-3 max-w-sm">
    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span class="text-sm font-medium"></span>
  </div>
</div>

<!-- Enhanced Folder Tree Section -->
<div class="mt-8 bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
  <div class="bg-gradient-to-r from-slate-50 to-slate-100 px-6 py-4 border-b border-slate-200">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center">
        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-slate-900">Folder Structure</h2>
        <p class="text-sm text-slate-600">Organize and navigate your files</p>
      </div>
    </div>
  </div>
  <div class="p-6">
    <div id="folder-tree"></div>
  </div>
</div>

<!-- Enhanced Old Sessions Browser -->
<div class="mt-8 bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
  <div class="bg-gradient-to-r from-amber-50 to-orange-50 px-6 py-4 border-b border-slate-200">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-slate-900">Browse Previous Sessions</h2>
        <p class="text-sm text-slate-600">Access files from archived sessions</p>
      </div>
    </div>
  </div>
  
  <div class="p-6">
    <div class="mb-6">
      <div class="flex flex-col lg:flex-row lg:items-center gap-4">
        <div class="flex-1">
          <label class="block text-sm font-semibold text-slate-700 mb-2">Select Session</label>
          <select id="old-session" class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white">
            <option value="">Select Session</option>
          </select>
        </div>
        
        <div class="flex items-center gap-3">
          <div class="px-4 py-2 bg-slate-100 rounded-lg">
            <span class="text-sm text-slate-600">Department:</span>
            <span id="old-dept-name" class="text-sm font-semibold text-slate-900 ml-2">Your department</span>
          </div>
          
          <button onclick="loadOldSessionFiles()" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-xl hover:from-blue-700 hover:to-blue-800 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 font-medium flex items-center gap-2 shadow-lg hover:shadow-xl">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            Browse
          </button>
        </div>
      </div>
    </div>
    
    <div id="old-session-files" class="space-y-3">
      <!-- Old session files will be displayed here -->
    </div>
  </div>
</div>

<!-- Enhanced Share Modal -->
<div id="share-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95 opacity-0" id="share-modal-content">
    <div class="p-8">
      <div class="flex items-center justify-center mb-6">
        <div class="w-12 h-12 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-xl flex items-center justify-center">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
          </svg>
        </div>
      </div>
      
      <div class="text-center mb-6">
        <h3 class="text-xl font-semibold text-slate-900 mb-2">Share File</h3>
        <p class="text-slate-600">Create a shareable link with custom settings</p>
      </div>
      
      <form id="share-form" class="space-y-5">
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">Share Type</label>
          <select id="share-type" class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white" onchange="toggleShareFields()">
            <option value="public">Public Link</option>
            <option value="email">Email Restricted</option>
            <option value="password">Password Protected</option>
          </select>
        </div>
        
        <div id="email-field" class="hidden">
          <label class="block text-sm font-semibold text-slate-700 mb-2">Email Address</label>
          <input type="email" id="share-email" class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-900 placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white" placeholder="user@example.com" autocomplete="email">
        </div>
        
        <div id="password-field" class="hidden">
          <label class="block text-sm font-semibold text-slate-700 mb-2">Password</label>
          <input type="password" id="share-password" class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-900 placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white" placeholder="Enter password" autocomplete="current-password">
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">
            Max Downloads 
            <span class="text-slate-500 font-normal">(optional)</span>
          </label>
          <input type="number" id="max-downloads" class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-900 placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white" placeholder="Leave empty for unlimited">
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">
            Expiry Date 
            <span class="text-slate-500 font-normal">(optional)</span>
          </label>
          <input type="datetime-local" id="expiry-date" class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white">
        </div>
        
        <div class="flex gap-3 pt-2">
          <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl py-3 px-4 hover:from-blue-700 hover:to-blue-800 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 font-medium flex items-center justify-center gap-2 shadow-lg hover:shadow-xl">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
            </svg>
            Create Share Link
          </button>
          <button type="button" onclick="closeShareModal()" class="flex-1 bg-slate-100 text-slate-700 rounded-xl py-3 px-4 hover:bg-slate-200 focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition-all duration-200 font-medium flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Runtime config for JS -->
<div id="dashboard-config" data-is-staff="{% if is_staff %}true{% else %}false{% endif %}"
     data-user-active-session-id="{% if active_session %}{{ active_session.id }}{% else %}{% endif %}"
     data-allowed-exts="{% if allowed_exts %}{{ allowed_exts|join:',' }}{% endif %}"></div>

<script>
  // -------- Upload progress helpers (XHR) --------
  function humanSpeed(bytesPerSec){
    if (!bytesPerSec || !isFinite(bytesPerSec)) return '0 KB/s';
    const units=['B/s','KB/s','MB/s','GB/s'];
    let i=0, v=bytesPerSec;
    while(v>=1024 && i<units.length-1){ v/=1024; i++; }
    return v.toFixed(v>=100?0:(v>=10?1:2))+' '+units[i];
  }

  function showProgress(name){
    const box=document.getElementById('upload-progress');
    document.getElementById('upload-progress-name').textContent=name||'Uploading…';
    document.getElementById('upload-progress-bar').style.width='0%';
    document.getElementById('upload-progress-percent').textContent='0%';
    document.getElementById('upload-progress-speed').textContent='0 KB/s';
    box.classList.remove('hidden');
  }
  function updateProgress(pct,speed){
    document.getElementById('upload-progress-bar').style.width=pct+'%';
    document.getElementById('upload-progress-percent').textContent=Math.floor(pct)+'%';
    if (speed!=null) document.getElementById('upload-progress-speed').textContent=humanSpeed(speed);
  }
  function hideProgress(){
    document.getElementById('upload-progress').classList.add('hidden');
  }

  function uploadWithProgress(url, formData, name){
    return new Promise((resolve, reject)=>{
      const xhr=new XMLHttpRequest();
      xhr.open('POST', url, true);
      try{ xhr.setRequestHeader('X-CSRFToken', getCsrf()); }catch(e){}
      let start=Date.now();
      showProgress(name);
      xhr.upload.onprogress=(e)=>{
        if(e.lengthComputable){
          const pct=(e.loaded/e.total)*100;
          const elapsedMs = Date.now()-start;
          const speed = elapsedMs>0 ? (e.loaded/(elapsedMs/1000)) : 0; // bytes/sec
          updateProgress(pct, speed);
        }
      };
      xhr.onreadystatechange=function(){
        if(xhr.readyState===4){
          if(xhr.status>=200 && xhr.status<300){
            try{ resolve(JSON.parse(xhr.responseText)); }catch(_){ resolve({}); }
          }else{
            reject(new Error(xhr.responseText||('HTTP '+xhr.status)));
          }
          setTimeout(hideProgress, 800);
        }
      };
      xhr.onerror=()=>{ hideProgress(); reject(new Error('Network error')); };
      xhr.send(formData);
    });
  }

  let currentFileId = null;
  let currentFolderId = null;
  
  // -------- Allowed file types (client-side guard; server enforces too) --------
  // Will be populated from server; falls back to sensible defaults
  let ALLOWED_EXTENSIONS = (window.__allowedExts && Array.isArray(window.__allowedExts)) ? window.__allowedExts : ['pdf','doc','docx','ppt','pptx','xls','xlsx','txt','zip','rar','jpg','jpeg','png','gif'];
  function getExtension(name){
    const i = String(name||'').lastIndexOf('.');
    return i>=0 ? String(name).slice(i+1).toLowerCase() : '';
  }
  function isAllowedFile(name){
    const ext = getExtension(name);
    return ext && ALLOWED_EXTENSIONS.includes(ext);
  }
  
  const __cfgEl = document.getElementById('dashboard-config');
  const IS_STAFF = __cfgEl ? (__cfgEl.dataset.isStaff === 'true') : false;
  const USER_ACTIVE_SESSION_ID = __cfgEl ? (__cfgEl.dataset.userActiveSessionId || null) : null;
  
  async function init() {
    const [s, d, c, p] = await Promise.all([
      fetch('/api/sessions/').then(r => r.json()).catch(()=>[]),
      fetch('/api/departments/').then(r => r.json()).catch(()=>[]),
      fetch('/api/categories/').then(r => r.json()).catch(()=>[]),
      fetch('/api/profile/').then(r => r.ok ? r.json() : null).catch(()=>null)
    ]);

    // Bring allowed extensions from server if provided
    try {
      const extsEl = document.getElementById('dashboard-config');
      const extsAttr = extsEl ? extsEl.getAttribute('data-allowed-exts') : null;
      if (extsAttr) {
        const parsed = extsAttr.split(',').map(s=>s.trim()).filter(Boolean);
        if (parsed.length) {
          ALLOWED_EXTENSIONS = parsed.map(x => String(x).toLowerCase());
        }
      }
    } catch (_) {}
    
    // Populate dropdowns with locks
    // Show all sessions, but default to user's active session
    const userActiveSession = Array.isArray(s) ? s.find(x => String(x.id) === String(USER_ACTIVE_SESSION_ID)) || s[0] : null;
    const sessionEl = document.getElementById('session');
    sessionEl.innerHTML = '<option value="">Select Session</option>' + 
      s.map(x => `<option value="${x.id}">${x.name} ${x.is_active ? '(Active)' : '(Archived)'}</option>`).join('');
    if (userActiveSession) { 
      sessionEl.value = String(userActiveSession.id); 
    }
    if (!IS_STAFF) {
      sessionEl.disabled = true;
      sessionEl.title = 'Session is set automatically by admin (global or override)';
    }
    // Keep session dropdown enabled so users can select different sessions

    const deptEl = document.getElementById('department');
    const dArr = Array.isArray(d) ? d : [];
    deptEl.innerHTML = '<option value="">Select Department</option>' + 
      dArr.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
    if (p && p.department) { deptEl.value = String(p.department); }
    deptEl.disabled = true;

    const cArr = Array.isArray(c) ? c : [];
    document.getElementById('category').innerHTML = '<option value="">No Category</option>' + 
      cArr.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
    
    // Populate old session dropdowns and show locked department label
    const oldSessionEl = document.getElementById('old-session');
    oldSessionEl.innerHTML = '<option value="">Select Session</option>' + 
      s.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
    const oldDeptNameEl = document.getElementById('old-dept-name');
    if (oldDeptNameEl && p && p.department) {
      const deptObj = d.find(x => String(x.id) === String(p.department));
      oldDeptNameEl.textContent = deptObj ? deptObj.name : 'Your department';
    }
    
    loadFolderTree();
    initDrive();
    setInterval(refreshLocks, 15000);
  }

  async function refreshLocks() {
    try {
      const [s, p] = await Promise.all([
        fetch('/api/sessions/').then(r => r.json()),
        fetch('/api/profile/').then(r => r.ok ? r.json() : null)
      ]);
      // Show all sessions, but default to user's active session
      const userActiveSession = Array.isArray(s) ? s.find(x => String(x.id) === String(USER_ACTIVE_SESSION_ID)) || s[0] : null;
      const sessionEl = document.getElementById('session');
      if (userActiveSession) { 
        sessionEl.value = String(userActiveSession.id); 
      }
      // Keep session dropdown enabled
      const deptEl = document.getElementById('department');
      if (p && p.department) { deptEl.value = String(p.department); }
      deptEl.disabled = true;
    } catch (e) { }
  }


  async function delFile(id) {
    if (confirm('Are you sure you want to delete this file?')) {
      await fetch(`/api/files/${id}/`, { method: 'DELETE', headers: { 'X-CSRFToken': getCsrf() } });
      loadFolderTree();
    }
  }

  async function delFolder(id) {
    const folder = driveFolders.find(f => f.id === id);
    if (!folder) return;
    
    const message = `Are you sure you want to delete the folder "${folder.name}"? This will also delete all files and subfolders inside it. This action cannot be undone.`;
    if (confirm(message)) {
      try {
        const response = await fetch(`/api/folders/${id}/`, { method: 'DELETE', headers: { 'X-CSRFToken': getCsrf() } });
        if (response.ok) {
          showToast('Folder deleted successfully', { success: true });
          await refreshDrive();
          loadFolderTree();
        } else {
          const error = await response.json().catch(() => ({ detail: 'Failed to delete folder' }));
          showToast(error.detail || 'Failed to delete folder');
        }
      } catch (error) {
        showToast('Failed to delete folder');
      }
    }
  }


  function openFolderShareModal(folderId) {
    const folder = driveFolders.find(f => f.id === folderId);
    if (!folder) return;
    
    currentFileId = null; // Clear file ID since we're sharing a folder
    currentFolderId = folderId; // Set folder ID
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
      <div class="bg-white rounded-xl w-full max-w-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Share Folder: ${folder.name}</h3>
          <button onclick="this.closest('.fixed').remove()" class="text-slate-500">✕</button>
        </div>
        <form id="folder-share-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Share Type</label>
            <select id="folder-share-type" class="w-full border rounded px-3 py-2" onchange="toggleFolderShareOptions()">
              <option value="public">Public Link</option>
              <option value="email">Email Restricted</option>
              <option value="password">Password Protected</option>
            </select>
          </div>
          
          <div id="folder-share-email-option" class="hidden">
            <label class="block text-sm font-medium mb-2">Email Address</label>
            <input type="email" id="folder-share-email" class="w-full border rounded px-3 py-2" placeholder="Enter email address" autocomplete="email">
          </div>
          
          <div id="folder-share-password-option" class="hidden">
            <label class="block text-sm font-medium mb-2">Password</label>
            <input type="password" id="folder-share-password" class="w-full border rounded px-3 py-2" placeholder="Enter password">
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-2">Max Downloads (optional)</label>
            <input type="number" id="folder-max-downloads" class="w-full border rounded px-3 py-2" placeholder="Leave empty for unlimited">
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-2">Expiry Date (optional)</label>
            <input type="datetime-local" id="folder-expiry-date" class="w-full border rounded px-3 py-2">
          </div>
          
          <button type="submit" class="w-full bg-primary text-white rounded py-2 hover:bg-blue-700">
            Create Share Link
          </button>
        </form>
      </div>
    `;
    document.body.appendChild(modal);
    
    // Add event listener for share type change
    modal.querySelector('#folder-share-type').addEventListener('change', toggleFolderShareOptions);
  }

  function toggleFolderShareOptions() {
    const shareType = document.getElementById('folder-share-type').value;
    const emailOption = document.getElementById('folder-share-email-option');
    const passwordOption = document.getElementById('folder-share-password-option');
    
    if (emailOption && passwordOption) {
      emailOption.classList.toggle('hidden', shareType !== 'email');
      passwordOption.classList.toggle('hidden', shareType !== 'password');
    }
  }
  
  function getCsrf() {
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    if (m) return m[1];
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta && meta.content) return meta.content;
    const inp = document.getElementById('_csrf_input');
    if (inp && inp.value) {
      const v = String(inp.value);
      // {% csrf_token %} renders as an input HTML string in some contexts; extract value if needed
      if (v && v !== 'None') return v.replace(/^[^A-Za-z0-9]+|[^A-Za-z0-9]+$/g, '');
    }
    return '';
  }

  // Ensure CSRF cookie is set on initial load
  (function ensureCsrfCookie() {
    if (!getCsrf()) {
      fetch('/api/profile/', { credentials: 'same-origin' }).catch(()=>{});
    }
  })();
  
  // Search functionality
  async function performSearch() {
    const query = document.getElementById('search-input').value.trim();
    if (!query) return;
    
    try {
      const response = await fetch(`/api/search/?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      
      const resultsDiv = document.getElementById('search-results');
      const contentDiv = document.getElementById('search-results-content');
      
      if (data.count === 0) {
        contentDiv.innerHTML = '<p class="text-slate-500">No results found.</p>';
      } else {
        contentDiv.innerHTML = data.results.map(f => `
          <div class="flex items-center justify-between border rounded p-3">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-slate-100 rounded flex items-center justify-center">
                <span class="text-slate-600 text-xs">${f.file_extension || '?'}</span>
              </div>
              <div>
                <div class="font-medium">${f.name}</div>
                <div class="text-sm text-slate-500">${f.department_name} • ${f.session_name}</div>
              </div>
            </div>
            <a href="${f.file}" class="text-primary text-sm hover:text-blue-700">Download</a>
          </div>
        `).join('');
      }
      
      resultsDiv.classList.remove('hidden');
    } catch (error) {
      console.error('Search error:', error);
    }
  }
  
  // Enhanced sharing
  function openShareModal(fileId) {
    currentFileId = fileId;
    document.getElementById('share-form').reset();
    toggleShareFields();
    showModalWithAnimation('share-modal', 'share-modal-content');
  }
  
  function closeShareModal() {
    hideModalWithAnimation('share-modal', 'share-modal-content');
    currentFileId = null;
  }
  
  function toggleShareFields() {
    const shareType = document.getElementById('share-type').value;
    const emailField = document.getElementById('email-field');
    const passwordField = document.getElementById('password-field');
    
    emailField.classList.toggle('hidden', shareType !== 'email');
    passwordField.classList.toggle('hidden', shareType !== 'password');
  }
  
  // Folder tree functions
  async function loadFolderTree() {
    const res = await fetch('/api/folders/');
    const folders = await res.json().catch(()=>[]);
    const foldersArr = Array.isArray(folders) ? folders : [];
    const parentSelect = document.getElementById('parent');
    parentSelect.innerHTML = '<option value="">Root</option>';
    foldersArr.forEach(f => {
      parentSelect.innerHTML += `<option value="${f.id}">${f.department_name} - ${f.name}</option>`;
    });

    // Build folder meta map for quick lookup (session, department)
    window.folderMetaById = {};
    foldersArr.forEach(f => {
      window.folderMetaById[f.id] = { session: f.session, department: f.department };
    });
    
    // Display folder tree
    const treeDiv = document.getElementById('folder-tree');
    treeDiv.innerHTML = renderFolderTree(foldersArr);
  }
  
  function renderFolderTree(folders, parentId = null) {
    const children = folders.filter(f => f.parent === parentId);
    if (children.length === 0) return '<p class="text-slate-500">No folders created yet.</p>';
    
    let html = '<ul class="space-y-2">';
    children.forEach(folder => {
      html += `
        <li class="border rounded p-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-2xl">📁</span>
              <div>
                <div class="font-medium">${folder.name}</div>
                <div class="text-sm text-slate-500">${folder.department_name} • ${folder.children_count} subfolders • ${folder.files_count} files</div>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="expandFolder(${folder.id})" class="text-blue-600 hover:text-blue-700 text-sm">Expand</button>
              <button onclick="shareFolder(${folder.id})" class="text-green-600 hover:text-green-700 text-sm">Share</button>
              <button onclick="toggleFolderVisibility(${folder.id}, true)" class="text-emerald-600 hover:text-emerald-700 text-sm">Make Public</button>
              <button onclick="toggleFolderVisibility(${folder.id}, false)" class="text-amber-600 hover:text-amber-700 text-sm">Make Private</button>
              <button onclick="deleteFolder(${folder.id})" class="text-red-600 hover:text-red-700 text-sm">Delete</button>
              <label class="text-sm cursor-pointer bg-slate-200 px-2 py-1 rounded hover:bg-slate-300">
                Upload here
                <input type="file" class="hidden" onchange="uploadIntoFolder(${folder.id}, event)" />
              </label>
              <label class="text-sm cursor-pointer bg-slate-200 px-2 py-1 rounded hover:bg-slate-300">
                Upload folder here
                <input type="file" class="hidden" webkitdirectory directory multiple onchange="uploadFolderIntoFolder(${folder.id}, event)" />
              </label>
            </div>
          </div>
          <div id="folder-${folder.id}-children" class="mt-3 hidden"></div>
        </li>
      `;
    });
    html += '</ul>';
    return html;
  }
  
  async function expandFolder(folderId) {
    const response = await fetch(`/api/folders/${folderId}/children/`);
    const data = await response.json();
    const childrenDiv = document.getElementById(`folder-${folderId}-children`);
    
    if (childrenDiv.classList.contains('hidden')) {
      let html = '<div class="ml-6 space-y-2">';
      
      if (data.children.length > 0) {
        html += '<div class="font-medium text-slate-700 mb-2">Subfolders:</div>';
        data.children.forEach(folder => {
          html += `<div class="flex items-center gap-2 text-slate-600">📁 ${folder.name}</div>`;
        });
      }
      
      if (data.files.length > 0) {
        html += '<div class="font-medium text-slate-700 mb-2 mt-3">Files:</div>';
        data.files.forEach(file => {
          html += `<div class="flex items-center gap-2"><span class="text-slate-600">📄</span> <a href="${file.file}" class="text-primary hover:text-blue-700">${file.name}</a></div>`;
        });
      }
      
      html += '</div>';
      childrenDiv.innerHTML = html;
      childrenDiv.classList.remove('hidden');
    } else {
      childrenDiv.classList.add('hidden');
    }
  }

  async function shareFolder(folderId) {
    const formData = new FormData();
    formData.append('folder', folderId);
    formData.append('share_type', 'public');
    const res = await fetch('/api/share/', { method: 'POST', body: formData, headers: { 'X-CSRFToken': getCsrf() } });
    const json = await res.json();
    if (!res.ok) { alert('Folder share failed: ' + (json.detail || JSON.stringify(json))); return; }
    alert('Folder share link: ' + json.share_url);
  }

  async function toggleFolderVisibility(folderId, isPublic) {
    console.log('toggleFolderVisibility called with:', { folderId, isPublic });
    // Find the folder in the folder tree data
    let folder = null;
    if (window.folderTreeData) {
      folder = findFolderInTree(window.folderTreeData, folderId);
    }
    
    if (!folder) {
      // Fallback: try to find in driveFolders
      folder = driveFolders.find(f => f.id === folderId);
    }
    
    if (!folder) {
      showToast('Folder not found');
      return;
    }
    
    const currentVisibility = folder.is_public;
    const newVisibility = isPublic;
    
    if (currentVisibility === newVisibility) return;
    
    const action = newVisibility ? 'make public' : 'make private';
    const title = `Confirm ${action.charAt(0).toUpperCase() + action.slice(1)}`;
    const message = newVisibility 
      ? `Are you sure you want to make the folder "${folder.name}" public? This will make it and all its contents visible on the landing page to everyone.`
      : `Are you sure you want to make the folder "${folder.name}" private? This will hide it and all its contents from the landing page and only you will be able to see them.`;
    
    showConfirmationDialog(title, message, async () => {
      try {
        const fd = new FormData();
        fd.append('is_public', newVisibility);
        
        const res = await fetch(`/api/folders/${folderId}/visibility/`, { 
          method: 'POST', 
          body: fd, 
          headers: { 'X-CSRFToken': getCsrf() } 
        });
        
        if (!res.ok) {
          const error = await res.json().catch(() => ({ detail: 'Failed to update visibility' }));
          showToast(error.detail || 'Failed to update visibility');
          return;
        }
        
        showToast(`Folder ${action} successfully`, { success: true });
    loadFolderTree();
        await refreshDrive();
      } catch (error) {
        showToast('Failed to update visibility');
      }
    });
  }

  // Helper function to find folder in tree structure
  function findFolderInTree(treeData, folderId) {
    for (const session of treeData) {
      for (const dept of session.departments) {
        const found = findFolderRecursive(dept.folders, folderId);
        if (found) return found;
      }
    }
    return null;
  }

  function findFolderRecursive(folders, folderId) {
    for (const folder of folders) {
      if (folder.id === folderId) return folder;
      if (folder.children && folder.children.length > 0) {
        const found = findFolderRecursive(folder.children, folderId);
        if (found) return found;
      }
    }
    return null;
  }

  async function deleteFolder(folderId) {
    if (!confirm('Delete this folder? This will also delete its subfolders and files.')) return;
    const res = await fetch(`/api/folders/${folderId}/`, { method: 'DELETE', headers: { 'X-CSRFToken': getCsrf() } });
    if (res.ok) { loadFolderTree(); } else { alert('Failed to delete folder'); }
  }

  async function uploadIntoFolder(folderId, event) {
    const file = event.target.files[0];
    if (!file) return;
    if (!isAllowedFile(file.name)) { showToast('File type not allowed: ' + file.name); event.target.value=''; return; }
    let ses = document.getElementById('session').value;
    let dep = document.getElementById('department').value;
    const cat = document.getElementById('category').value;
    const description = document.getElementById('description').value;
    const isPublic = document.getElementById('visibility-public').checked;

    // Fallback to folder's own session/department if not selected in form
    if ((!ses || !dep) && window.folderMetaById && window.folderMetaById[folderId]) {
      const meta = window.folderMetaById[folderId];
      ses = ses || meta.session;
      dep = dep || meta.department;
    }

    const fd = new FormData();
    fd.append('session', ses);
    fd.append('department', dep);
    fd.append('folder', folderId);
    if (cat) fd.append('category', cat);
    if (description) fd.append('description', description);
    fd.append('file', file);
    fd.append('is_public', isPublic);
    try{
      await uploadWithProgress('/api/files/', fd, file.name || 'Uploading file');
    }catch(err){
      const msg=String(err.message||err);
      if (msg.toLowerCase().includes('not allowed')) { showToast(msg); } else { alert('Upload failed: ' + msg); }
      return;
    }
    loadFolderTree();
  }

  async function uploadFolderIntoFolder(folderId, event) {
    const files = event.target.files;
    if (!files || files.length === 0) {
      return;
    }
    // Filter disallowed files early and warn
    const accepted = [];
    const rejected = [];
    Array.from(files).forEach(f=>{ (isAllowedFile(f.name) ? accepted : rejected).push(f); });
    if (rejected.length){
      showToast('Some files were blocked (type not allowed): ' + rejected.slice(0,3).map(f=>f.name).join(', ') + (rejected.length>3?(' and '+(rejected.length-3)+' more'):'') );
    }
    if (!accepted.length){ return; }

    let ses = document.getElementById('session').value;
    let dep = document.getElementById('department').value;
    const cat = document.getElementById('category').value;
    const description = document.getElementById('description').value;
    const isPublic = document.getElementById('visibility-public').checked;

    // Build and create subfolders under folderId, then upload files
    const folderIdByPath = new Map();
    const rootParentId = folderId;
    folderIdByPath.set('', rootParentId);

    const folderPaths = new Set();
    for (const f of files) {
      const relPath = f.webkitRelativePath || f.name;

      const parts = relPath.split('/');
      parts.pop(); // remove filename
      let pathAcc = '';
      for (const part of parts) {
        pathAcc = pathAcc ? `${pathAcc}/${part}` : part;
        folderPaths.add(pathAcc);
      }

      // If file is in root of folder (no subfolder), add empty string to ensure root folder is created
      if (parts.length === 0) {
        folderPaths.add('');
      }
    }

    const sortedPaths = Array.from(folderPaths).sort((a, b) => a.split('/').length - b.split('/').length);

    for (const path of sortedPaths) {
      if (folderIdByPath.has(path)) continue;
      const segments = path.split('/');
      const name = segments[segments.length - 1];
      const parentPath = segments.slice(0, -1).join('/');
      const parentId = folderIdByPath.get(parentPath) || rootParentId;

      const fd = new FormData();
      fd.append('name', name);
      if (parentId) fd.append('parent', parentId);
      if (cat) fd.append('category', cat);
      if (description) fd.append('description', description);
      fd.append('is_public', isPublic);

      const res = await fetch('/api/folders/', { method: 'POST', body: fd, headers: { 'X-CSRFToken': getCsrf() } });
      const json = await res.json();

      if (!res.ok) {
        alert('Folder create failed: ' + (json.detail || JSON.stringify(json)));
        return;
      }
      folderIdByPath.set(path, json.id);
    }

    // Upload files
    for (const f of accepted) {
      const relPath = f.webkitRelativePath || f.name;
      const folderPath = relPath.split('/').slice(0, -1).join('/');
      const targetFolderId = folderIdByPath.get(folderPath) || rootParentId;

      const fd2 = new FormData();
      fd2.append('session', ses);
      fd2.append('department', dep);
      if (targetFolderId) fd2.append('folder', targetFolderId);
      if (cat) fd2.append('category', cat);
      if (description) fd2.append('description', description);
      fd2.append('file', f);
      fd2.append('is_public', isPublic);

      try{
        await uploadWithProgress('/api/files/', fd2, f.name || 'Uploading…');
      }catch(err){
        const msg=String((err&&err.message)||err||'Unknown error');
        if (msg.toLowerCase().includes('not allowed')) { showToast('Upload failed for '+relPath+': '+msg); } else { alert('Upload failed for '+relPath+': '+msg); }
        return;
      }
    }

    loadFolderTree();
  }

  
  // Old sessions browser
  async function loadOldSessionFiles() {
    const sessionId = document.getElementById('old-session').value;
    const profile = await fetch('/api/profile/').then(r => r.ok ? r.json() : null);
    const deptId = profile && profile.department ? profile.department : '';

    if (!sessionId || !deptId) {
      alert('Your department is not set or session not selected');
      return;
    }

    const res = await fetch(`/api/browse/session/?session=${encodeURIComponent(sessionId)}&department=${encodeURIComponent(deptId)}`);
    if (!res.ok) {
      const j = await res.json().catch(() => ({ detail: 'Unknown error' }));
      alert('Failed to load: ' + (j.detail || JSON.stringify(j)));
      return;
    }
    const data = await res.json();
    const filesDiv = document.getElementById('old-session-files');

    function renderTreeNode(node, indent = 0) {
      let html = `<div class="ml-${indent}">📁 ${node.name}${node.is_public ? '' : ' <span class=\"text-xs text-slate-400\">(Private)</span>'}</div>`;
      if (node.files && node.files.length) {
        node.files.forEach(f => {
          html += `<div class=\"ml-${indent + 4}\"><a href=\"${f.file}\" class=\"text-primary\">📄 ${f.name}</a>${f.is_public ? '' : ' <span class=\\"text-xs text-slate-400\\">(Private)</span>'}</div>`;
        });
      }
      if (node.children && node.children.length) {
        node.children.forEach(ch => { html += renderTreeNode(ch, indent + 4); });
      }
      return html;
    }

    let html = '<div class="space-y-3">';
    if (data.root_files && data.root_files.length) {
      html += '<div><h3 class="font-medium text-slate-700 mb-2">Files:</h3>';
      data.root_files.forEach(f => {
        html += `<div><a href=\"${f.file}\" class=\"text-primary\">📄 ${f.name}</a>${f.is_public ? '' : ' <span class=\\"text-xs text-slate-400\\">(Private)</span>'}</div>`;
      });
      html += '</div>';
    }
    if (data.folders_tree && data.folders_tree.length) {
      html += '<div><h3 class="font-medium text-slate-700 mb-2">Folders:</h3>';
      data.folders_tree.forEach(node => { html += renderTreeNode(node, 4); });
      html += '</div>';
    }
    if ((!data.root_files || !data.root_files.length) && (!data.folders_tree || !data.folders_tree.length)) {
      html += '<p class="text-slate-500">No files or folders found in this session for your department.</p>';
    }
    html += '</div>';

    filesDiv.innerHTML = html;
  }
  
  // File filtering
  function filterFiles() {
    const filter = document.getElementById('file-filter').value;
    // Implementation for filtering files
  }
  
  function refreshFiles() {
    loadFolderTree();
  }

  // Drive-like UI
  let driveCurrentFolderId = null;
  let driveFolders = [];
  let driveFiles = [];
  
  // Initialize global variable for drag-drop
  window.driveCurrentFolderId = null;

  async function initDrive() {
    await refreshDrive();
  }

  async function refreshDrive() {
    const [foldersRes, filesRes] = await Promise.all([
      fetch('/api/folders/'),
      fetch('/api/files/')
    ]);
    driveFolders = await foldersRes.json();
    driveFiles = await filesRes.json();
    renderDrive();
  }

  function renderDriveBreadcrumb() {
    const el = document.getElementById('drive-breadcrumb');
    if (!driveCurrentFolderId) { el.textContent = '/'; return; }
    // Build path from current folder up to root
    const byId = Object.fromEntries(driveFolders.map(f => [f.id, f]));
    const parts = [];
    let f = byId[driveCurrentFolderId];
    while (f) { parts.push(f.name); f = f.parent ? byId[f.parent] : null; }
    parts.reverse();
    el.textContent = '/' + parts.join('/');
  }

  function renderDrive() {
    renderDriveBreadcrumb();
    const grid = document.getElementById('drive-grid');
    const backBtn = document.getElementById('drive-back-btn');
    if (backBtn) backBtn.disabled = !driveCurrentFolderId;
    const parentId = driveCurrentFolderId;
    
    // Filter folders and files based on current tab
    let filteredFolders = driveFolders.filter(f => (f.parent || null) === (parentId || null));
    let filteredFiles = driveFiles.filter(x => (x.folder || null) === (parentId || null));
    
    // Apply tab filter
    if (currentTab === 'public') {
      filteredFolders = filteredFolders.filter(f => f.is_public);
      filteredFiles = filteredFiles.filter(f => f.is_public);
    } else if (currentTab === 'private') {
      filteredFolders = filteredFolders.filter(f => !f.is_public);
      filteredFiles = filteredFiles.filter(f => !f.is_public);
    }
    // 'all' tab shows everything, no additional filtering needed
    
    const folders = filteredFolders;
    const files = filteredFiles;

    if (folders.length === 0 && files.length === 0) {
      grid.innerHTML = '<div class="col-span-full text-slate-500">Empty folder</div>';
      return;
    }

    let html = '';
    folders.forEach(f => {
      html += `
        <div class="group border rounded-lg p-3 hover:shadow bg-white folder-item grid-item-sortable select-none relative z-0 cursor-default" data-folder-id="${f.id}" draggable="true">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded bg-amber-100 text-amber-700 flex items-center justify-center cursor-pointer" onclick="driveOpenFolder(${f.id})">📁</div>
            <div class="min-w-0 flex-1 cursor-pointer" onclick="driveOpenFolder(${f.id})">
              <div class="font-medium truncate flex items-center gap-2">
                ${f.name}
                ${f.is_public ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">Public</span>' : '<span class="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded">Private</span>'}
              </div>
              <div class="text-xs text-slate-500">${f.children_count} folders • ${f.files_count} files</div>
            </div>
            <div class="relative z-[200]">
              <button class="w-8 h-8 rounded hover:bg-slate-100 flex items-center justify-center" onclick="event.stopPropagation(); toggleFolderMenu(${f.id}, this)" aria-label="More">
                ⋮
              </button>
              <div id="folder-menu-${f.id}" class="hidden absolute right-0 mt-2 w-36 bg-white border rounded shadow z-[9999]">
                <button class="block w-full text-left px-3 py-2 text-sm hover:bg-slate-50" onclick="driveOpenFolder(${f.id}); hideAllMenus();">Open</button>
                <button class="block w-full text-left px-3 py-2 text-sm hover:bg-slate-50" onclick="openFolderShareModal(${f.id}); hideAllMenus();">Share</button>
                ${f.is_public ? 
                  '<button class="block w-full text-left px-3 py-2 text-sm hover:bg-slate-50" onclick="toggleFolderVisibility(' + f.id + ', false); hideAllMenus();">Make Private</button>' :
                  '<button class="block w-full text-left px-3 py-2 text-sm hover:bg-slate-50" onclick="toggleFolderVisibility(' + f.id + ', true); hideAllMenus();">Make Public</button>'
                }
                <button class="block w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-slate-50" onclick="delFolder(${f.id}); hideAllMenus();">Delete</button>
              </div>
            </div>
          </div>
        </div>`;
    });
    files.forEach(f => {
      html += `
        <div class="border rounded-lg p-3 hover:shadow bg-white file-item grid-item-sortable select-none relative z-0 cursor-default" data-file-id="${f.id}" draggable="true">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded bg-slate-100 text-slate-600 flex items-center justify-center">${f.file_extension || '?'}</div>
            <div class="min-w-0 flex-1">
              <div class="font-medium truncate flex items-center gap-2" title="${f.name}">
                ${f.name}
                ${f.is_public ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">Public</span>' : '<span class="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded">Private</span>'}
              </div>
              <div class="text-xs text-slate-500 truncate">${f.file_size_display} • ${f.download_count} downloads</div>
            </div>
            <div class="relative z-[200]">
              <button class="w-8 h-8 rounded hover:bg-slate-100 flex items-center justify-center" onclick="event.stopPropagation(); toggleFileMenu(${f.id}, this)" aria-label="More">
                ⋮
              </button>
              <div id="file-menu-${f.id}" class="hidden absolute right-0 mt-2 w-36 bg-white border rounded shadow z-[9999]">
                <a href="${f.file}" class="block px-3 py-2 text-sm hover:bg-slate-50">Open</a>
                <button class="block w-full text-left px-3 py-2 text-sm hover:bg-slate-50" onclick="openShareModal(${f.id}); hideAllMenus();">Share</button>
                ${f.is_public ? 
                  '<button class="block w-full text-left px-3 py-2 text-sm hover:bg-slate-50" onclick="toggleFileVisibility(' + f.id + ', false); hideAllMenus();">Make Private</button>' :
                  '<button class="block w-full text-left px-3 py-2 text-sm hover:bg-slate-50" onclick="toggleFileVisibility(' + f.id + ', true); hideAllMenus();">Make Public</button>'
                }
                <button class="block w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-slate-50" onclick="delFile(${f.id}); hideAllMenus();">Delete</button>
              </div>
            </div>
          </div>
        </div>`;
    });
    grid.innerHTML = html;
    
    // Refresh drag and drop functionality for new elements
    if (window.dragDropManager) {
      window.dragDropManager.makeNewElementsDraggable();
    }
  }

  function driveOpenFolder(id) {
    driveCurrentFolderId = id;
    window.driveCurrentFolderId = id; // Set global variable for drag-drop
    renderDrive();
  }

  function hideAllMenus() {
    document.querySelectorAll('[id^="file-menu-"]').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('[id^="folder-menu-"]').forEach(el => el.classList.add('hidden'));
    const fm = document.getElementById('floating-menu');
    if (fm) { fm.classList.add('hidden'); fm.style.display='none'; fm.innerHTML=''; }
  }

  // Global click listener to auto-close menus when clicking outside
  document.addEventListener('click', function(e) {
    // Check if the clicked element is a menu button or inside a menu
    const isMenuButton = e.target.closest('[onclick*="toggleFileMenu"], [onclick*="toggleFolderMenu"]');
    const isInsideMenu = e.target.closest('[id^="file-menu-"], [id^="folder-menu-"]');
    
    // If clicking on a menu button, don't close menus (let the toggle function handle it)
    if (isMenuButton) {
      return;
    }
    
    // If clicking inside a menu, don't close it
    if (isInsideMenu) {
      return;
    }
    
    // Otherwise, close all menus
    hideAllMenus();
  });

  // Global keyboard listener to close menus on Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      hideAllMenus();
    }
  });
  // Disable double-click highlight/behavior on file and folder cards
  document.addEventListener('dblclick', function(e) {
    const isCard = e.target.closest('.file-item, .folder-item');
    if (isCard) {
      e.preventDefault();
      e.stopPropagation();
    }
  });

  function toggleFileMenu(id, btnEl) {
    hideAllMenus();
    const el = document.getElementById(`file-menu-${id}`);
    if (!el || !btnEl) return;
    showFloatingMenuFrom(el, btnEl);
  }

  function toggleFolderMenu(id, btnEl) {
    hideAllMenus();
    const el = document.getElementById(`folder-menu-${id}`);
    if (!el || !btnEl) return;
    showFloatingMenuFrom(el, btnEl);
  }

  function openProfilePanel() {
    const panel = document.createElement('div');
    panel.className = 'fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center p-4';
    panel.innerHTML = `
      <div class="bg-white rounded-xl w-full max-w-lg p-6">
        <div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold">Profile</h3><button onclick="this.closest('.fixed').remove()" class="text-slate-500">✕</button></div>
        <div id="profile-content" class="space-y-4">
          <div class="text-slate-500">Loading...</div>
        </div>
      </div>`;
    document.body.appendChild(panel);
    loadProfileInto(panel.querySelector('#profile-content'));
  }

  async function loadProfileInto(root) {
    try {
      const [u, p] = await Promise.all([
        fetch('/api/profile/').then(r => r.ok ? r.json() : null),
        Promise.resolve()
      ]);
      const user = u || {};
      root.innerHTML = `
        <form id="profile-user-form" class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-sm">Username</label><input name="username" class="w-full border rounded px-3 py-2" value="${(user.username || '')}"/></div>
            <div><label class="text-sm">Email</label><input name="email" type="email" class="w-full border rounded px-3 py-2" value="${(user.email || '')}"/></div>
            <div><label class="text-sm">First name</label><input name="first_name" class="w-full border rounded px-3 py-2" value="${(user.first_name || '')}"/></div>
            <div><label class="text-sm">Last name</label><input name="last_name" class="w-full border rounded px-3 py-2" value="${(user.last_name || '')}"/></div>
          </div>
          <button class="bg-primary text-white px-3 py-2 rounded" type="submit">Save Profile</button>
        </form>
        <form id="profile-pass-form" class="space-y-3 border-t pt-4">
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-sm">Current password</label><input name="current_password" type="password" class="w-full border rounded px-3 py-2"/></div>
            <div><label class="text-sm">New password</label><input name="new_password" type="password" class="w-full border rounded px-3 py-2"/></div>
          </div>
          <button class="bg-slate-700 text-white px-3 py-2 rounded" type="submit">Change Password</button>
        </form>
        <div class="text-xs text-slate-500">Department changes are restricted to admins.</div>
      `;
      root.querySelector('#profile-user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const res = await fetch('/api/profile/user/update/', { method: 'POST', body: fd, headers: { 'X-CSRFToken': getCsrf() } });
        if (res.ok) { showToast('Profile updated', { success: true }); } else { const j = await res.json().catch(() => ({ detail: 'Update failed' })); showToast(j.detail || 'Update failed'); }
      });
      root.querySelector('#profile-pass-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const res = await fetch('/api/profile/password/update/', { method: 'POST', body: fd, headers: { 'X-CSRFToken': getCsrf() } });
        if (res.ok) { showToast('Password changed', { success: true }); e.target.reset(); } else { const j = await res.json().catch(() => ({ detail: 'Change failed' })); showToast(j.detail || 'Change failed'); }
      });
    } catch (e) { root.innerHTML = '<div class="text-red-600">Failed to load profile</div>'; }
  }

  function showToast(message, opts) {
    const el = document.getElementById('toast');
    const inner = document.getElementById('toast-inner');
    if (!el || !inner) { alert(message); return; }
    
    const messageSpan = inner.querySelector('span');
    if (messageSpan) {
      messageSpan.textContent = message;
    } else {
      inner.textContent = message;
    }
    
    // Update toast styling based on success/error
    if (opts && opts.success) {
      inner.className = 'bg-emerald-600 text-white px-6 py-4 rounded-xl shadow-2xl border border-emerald-500 flex items-center gap-3 max-w-sm';
      inner.innerHTML = `
        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span class="text-sm font-medium">${message}</span>
      `;
    } else {
      inner.className = 'bg-red-600 text-white px-6 py-4 rounded-xl shadow-2xl border border-red-500 flex items-center gap-3 max-w-sm';
      inner.innerHTML = `
        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span class="text-sm font-medium">${message}</span>
      `;
    }
    
    // Show with animation
    el.classList.remove('hidden');
    el.classList.remove('translate-x-full', 'opacity-0');
    el.classList.add('translate-x-0', 'opacity-100');
    
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => { 
      el.classList.add('translate-x-full', 'opacity-0');
      setTimeout(() => { el.classList.add('hidden'); }, 300);
    }, 3000);
  }

  function driveGoUp() {
    if (!driveCurrentFolderId) return;
    const byId = Object.fromEntries(driveFolders.map(f => [f.id, f]));
    const cur = byId[driveCurrentFolderId];
    driveCurrentFolderId = cur && cur.parent ? cur.parent : null;
    window.driveCurrentFolderId = driveCurrentFolderId; // Update global variable for drag-drop
    renderDrive();
  }

  function driveGoToRoot() {
    driveCurrentFolderId = null;
    window.driveCurrentFolderId = null; // Update global variable for drag-drop
    renderDrive();
  }

  // Global variables for tab management
  let currentTab = 'all';
  let pendingVisibilityChange = null;

  // Tab switching functionality
  function switchTab(tab) {
    currentTab = tab;
    
    // Update tab buttons
    document.querySelectorAll('[id^="tab-"]').forEach(btn => {
      btn.classList.remove('border-primary', 'text-primary', 'bg-blue-50');
      btn.classList.add('border-transparent', 'text-slate-600');
    });
    
    const activeTab = document.getElementById(`tab-${tab}`);
    if (activeTab) {
      activeTab.classList.remove('border-transparent', 'text-slate-600');
      activeTab.classList.add('border-primary', 'text-primary', 'bg-blue-50');
    }
    
    // Update tab info
    const tabInfo = document.getElementById('current-tab-info');
    if (tabInfo) {
      const tabNames = { all: 'All Files', public: 'Public Files', private: 'Private Files' };
      tabInfo.textContent = tabNames[tab] || 'All Files';
    }
    
    // Refresh the drive view with current tab filter
    renderDrive();
  }

  // Enhanced modal animation functions
  function showModalWithAnimation(modalId, contentId) {
    const modal = document.getElementById(modalId);
    const content = document.getElementById(contentId);
    if (!modal || !content) return;
    
    modal.classList.remove('hidden');
    // Trigger animation on next frame
    requestAnimationFrame(() => {
      content.classList.remove('scale-95', 'opacity-0');
      content.classList.add('scale-100', 'opacity-100');
    });
  }
  
  function hideModalWithAnimation(modalId, contentId) {
    const modal = document.getElementById(modalId);
    const content = document.getElementById(contentId);
    if (!modal || !content) return;
    
    content.classList.remove('scale-100', 'opacity-100');
    content.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 300);
  }

  // Enhanced confirmation dialog functionality
  function showConfirmationDialog(title, message, onConfirm) {
    console.log('showConfirmationDialog called with:', { title, message });
    const modal = document.getElementById('confirmation-modal');
    const titleEl = document.getElementById('confirmation-title');
    const messageEl = document.getElementById('confirmation-message');
    const confirmBtn = document.getElementById('confirmation-confirm');
    const cancelBtn = document.getElementById('confirmation-cancel');
    
    console.log('Modal elements found:', { modal: !!modal, titleEl: !!titleEl, messageEl: !!messageEl, confirmBtn: !!confirmBtn, cancelBtn: !!cancelBtn });
    
    if (!modal || !titleEl || !messageEl || !confirmBtn || !cancelBtn) {
      console.error('Missing modal elements');
      return;
    }
    
    titleEl.textContent = title;
    messageEl.textContent = message;
    
    // Remove existing event listeners
    const newConfirmBtn = confirmBtn.cloneNode(true);
    const newCancelBtn = cancelBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    
    // Add new event listeners
    newConfirmBtn.addEventListener('click', () => {
      hideModalWithAnimation('confirmation-modal', 'confirmation-modal-content');
      if (onConfirm) onConfirm();
    });
    
    newCancelBtn.addEventListener('click', () => {
      hideModalWithAnimation('confirmation-modal', 'confirmation-modal-content');
    });
    
    // Show modal with animation
    showModalWithAnimation('confirmation-modal', 'confirmation-modal-content');
  }

  // Enhanced share success dialog functionality
  function showShareSuccessDialog(shareUrl) {
    const modal = document.getElementById('share-success-modal');
    const urlInput = document.getElementById('share-url-input');
    const copyBtn = document.getElementById('copy-share-url');
    const closeBtn = document.getElementById('share-success-close');
    
    if (!modal || !urlInput || !copyBtn || !closeBtn) {
      console.error('Missing share success modal elements');
      return;
    }
    
    // Set the share URL
    urlInput.value = shareUrl;
    
    // Remove existing event listeners
    const newCopyBtn = copyBtn.cloneNode(true);
    const newCloseBtn = closeBtn.cloneNode(true);
    copyBtn.parentNode.replaceChild(newCopyBtn, copyBtn);
    closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
    
    // Add new event listeners
    newCopyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(shareUrl);
        // Change button text temporarily to show success
        const originalText = newCopyBtn.innerHTML;
        newCopyBtn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Copied!
        `;
        newCopyBtn.classList.remove('from-blue-600', 'to-blue-700', 'hover:from-blue-700', 'hover:to-blue-800');
        newCopyBtn.classList.add('from-green-600', 'to-green-700', 'hover:from-green-700', 'hover:to-green-800');
        
        setTimeout(() => {
          newCopyBtn.innerHTML = originalText;
          newCopyBtn.classList.remove('from-green-600', 'to-green-700', 'hover:from-green-700', 'hover:to-green-800');
          newCopyBtn.classList.add('from-blue-600', 'to-blue-700', 'hover:from-blue-700', 'hover:to-blue-800');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy: ', err);
        // Fallback for older browsers
        urlInput.select();
        urlInput.setSelectionRange(0, 99999);
        document.execCommand('copy');
        showToast('URL copied to clipboard', { success: true });
      }
    });
    
    newCloseBtn.addEventListener('click', () => {
      hideModalWithAnimation('share-success-modal', 'share-success-modal-content');
    });
    
    // Show modal with animation
    showModalWithAnimation('share-success-modal', 'share-success-modal-content');
  }

  // Copy to clipboard utility function
  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch (err) {
      console.error('Failed to copy: ', err);
      return false;
    }
  }

  // Enhanced visibility toggle with confirmation
  async function toggleFileVisibility(id, isPublic) {
    console.log('toggleFileVisibility called with:', { id, isPublic });
    const item = driveFiles.find(f => f.id === id) || driveFolders.find(f => f.id === id);
    console.log('Item found:', item);
    if (!item) return;
    
    const currentVisibility = item.is_public;
    const newVisibility = isPublic;
    
    if (currentVisibility === newVisibility) return;
    
    const action = newVisibility ? 'make public' : 'make private';
    const title = `Confirm ${action.charAt(0).toUpperCase() + action.slice(1)}`;
    const message = newVisibility 
      ? `Are you sure you want to make "${item.name}" public? This will make it visible on the landing page to everyone.`
      : `Are you sure you want to make "${item.name}" private? This will hide it from the landing page and only you will be able to see it.`;
    
    showConfirmationDialog(title, message, async () => {
      try {
        const fd = new FormData();
        fd.append('is_public', newVisibility);
        
        const endpoint = item.folder_path ? `/api/folders/${id}/visibility/` : `/api/files/${id}/visibility/`;
        const res = await fetch(endpoint, { 
          method: 'POST', 
          body: fd, 
          headers: { 'X-CSRFToken': getCsrf() } 
        });
        
        if (!res.ok) {
          const error = await res.json().catch(() => ({ detail: 'Failed to update visibility' }));
          showToast(error.detail || 'Failed to update visibility');
          return;
        }
        
        showToast(`File ${action} successfully`, { success: true });
    await refreshDrive();
      } catch (error) {
        showToast('Failed to update visibility');
      }
    });
  }

  async function driveUploadFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    if (!isAllowedFile(file.name)) { showToast('File type not allowed: ' + file.name); e.target.value=''; return; }

    let ses = document.getElementById('session').value;
    let dep = document.getElementById('department').value;

    // Try to get session and department from current folder context if not set
    if ((!ses || !dep) && window.folderMetaById && driveCurrentFolderId) {
      const meta = window.folderMetaById[driveCurrentFolderId];
      if (meta) {
        ses = ses || meta.session;
        dep = dep || meta.department;
      }
    }

    if (!ses || !dep) {
      alert('Please select Session and Department (left panel) before uploading files.');
      e.target.value = '';
      return;
    }

    const fd = new FormData();
    fd.append('file', file);
    fd.append('session', ses);
    fd.append('department', dep);
    if (driveCurrentFolderId) {
      fd.append('folder', driveCurrentFolderId);
    }
    fd.append('is_public', document.getElementById('visibility-public').checked);

    try{
      await uploadWithProgress('/api/files/', fd, file.name || 'Uploading file');
    }catch(err){
      const msg = String((err&&err.message)||err||'Unknown error');
      alert('Upload failed: ' + msg);
      return;
    }

    await refreshDrive();
  }

  async function driveUploadFolder(e) {
    const files = e.target.files;
    if (!files || files.length === 0) {
      return;
    }

    let ses = document.getElementById('session').value;
    let dep = document.getElementById('department').value;

    if ((!ses || !dep) && window.folderMetaById && driveCurrentFolderId) {
      const meta = window.folderMetaById[driveCurrentFolderId];
      if (meta) {
        ses = ses || meta.session;
        dep = dep || meta.department;
    }
    }

    if (!ses || !dep) {
      alert('Please select Session and Department (left panel) before uploading a folder at root.');
      e.target.value = '';
      return;
    }

    try {
    // reuse helper but target current folder as parent
    await uploadFolderIntoFolder(driveCurrentFolderId || null, { target: { files } });
    await refreshDrive();
    } catch (error) {
      console.error('Error in driveUploadFolder:', error);
      alert('Folder upload failed: ' + error.message);
    }
  }
  
  // Share form submission
  document.getElementById('share-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('file_item', currentFileId);
    formData.append('share_type', document.getElementById('share-type').value);
    
    const shareType = document.getElementById('share-type').value;
    if (shareType === 'email') {
      formData.append('email', document.getElementById('share-email').value);
    } else if (shareType === 'password') {
      formData.append('password', document.getElementById('share-password').value);
    }
    
    const maxDownloads = document.getElementById('max-downloads').value;
    if (maxDownloads) formData.append('max_downloads', maxDownloads);
    
    const expiryDate = document.getElementById('expiry-date').value;
    if (expiryDate) formData.append('expires_at', expiryDate);
    
    try {
      const response = await fetch('/api/share/', {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': getCsrf() }
      });
      
      if (response.ok) {
        const shareData = await response.json();
        const shareUrl = shareData.share_url;
        closeShareModal();
        showShareSuccessDialog(shareUrl);
      } else {
        const error = await response.json().catch(() => ({ detail: 'Error creating share link' }));
        showToast(error.detail || 'Error creating share link');
      }
    } catch (error) {
      showToast('Error creating share link');
    }
  });

  // Folder share form submission (dynamic event listener)
  document.addEventListener('submit', async (e) => {
    if (e.target.id === 'folder-share-form') {
      e.preventDefault();
      
      const formData = new FormData();
      formData.append('folder', currentFolderId);
      formData.append('share_type', document.getElementById('folder-share-type').value);
      
      const shareType = document.getElementById('folder-share-type').value;
      if (shareType === 'email') {
        formData.append('email', document.getElementById('folder-share-email').value);
      } else if (shareType === 'password') {
        formData.append('password', document.getElementById('folder-share-password').value);
      }
      
      const maxDownloads = document.getElementById('folder-max-downloads').value;
      if (maxDownloads) formData.append('max_downloads', maxDownloads);
      
      const expiryDate = document.getElementById('folder-expiry-date').value;
      if (expiryDate) formData.append('expires_at', expiryDate);
      
      try {
        const response = await fetch('/api/share/', {
          method: 'POST',
          body: formData,
          headers: { 'X-CSRFToken': getCsrf() }
        });
        
        if (response.ok) {
          const shareData = await response.json();
          const shareUrl = shareData.share_url;
          e.target.closest('.fixed').remove(); // Close modal
          showShareSuccessDialog(shareUrl);
        } else {
          const error = await response.json().catch(() => ({ detail: 'Error creating share link' }));
          showToast(error.detail || 'Error creating share link');
              }
    } catch (error) {
      showToast('Error creating share link');
      }
    }
  });
  
  // Upload form submission
  document.getElementById('upload-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const ses = document.getElementById('session').value;
    const dep = document.getElementById('department').value;
    const cat = document.getElementById('category').value;
    const parent = document.getElementById('parent').value;
    const folderName = document.getElementById('folder-name').value;
    const description = document.getElementById('description').value;
    const isPublic = document.getElementById('visibility-public').checked;
    const file = document.getElementById('file').files[0];
    const folderSelection = document.getElementById('folder-upload').files;
    
    let folderId = parent || '';
    if (folderName) {
      const fd = new FormData();
      fd.append('session', ses);
      fd.append('department', dep);
      fd.append('name', folderName);
      if (parent) fd.append('parent', parent);
      fd.append('is_public', isPublic);
      if (cat) fd.append('category', cat);
      if (description) fd.append('description', description);
      
      try {
      let created = null;
      try{
        const res = await fetch('/api/folders/', { method: 'POST', body: fd, headers: { 'X-CSRFToken': getCsrf() } });
        if (res.status === 429) {
          // Simple backoff and retry once for throttling
          await new Promise(r=>setTimeout(r, 2000));
          const res2 = await fetch('/api/folders/', { method: 'POST', body: fd, headers: { 'X-CSRFToken': getCsrf() } });
          if (!res2.ok) { const j2 = await res2.json().catch(()=>({detail:'Throttled'})); throw new Error(j2.detail||'Throttled'); }
          created = await res2.json();
        } else if (!res.ok) {
          const j = await res.json().catch(()=>({detail:'Failed'}));
          throw new Error(j.detail||'Failed');
        } else {
          created = await res.json();
        }
      }catch(err){
        alert('Folder create failed: ' + (err.message || err));
          return;
        }
      folderId = created.id;
        alert('Folder created successfully!');
      } catch (error) {
        alert('Error creating folder');
        return;
      }
    }
    
    if (folderSelection && folderSelection.length > 0) {
      // Filter to allowed types
      const accepted = [];
      const rejected = [];
      Array.from(folderSelection).forEach(f=>{ (isAllowedFile(f.name) ? accepted : rejected).push(f); });
      if (rejected.length){
        showToast('Some files were blocked (type not allowed): ' + rejected.slice(0,3).map(f=>f.name).join(', ') + (rejected.length>3?(' and '+(rejected.length-3)+' more'):'') );
      }
      if (!accepted.length){ return; }
      await uploadEntireFolder({ ses, dep, cat, parent, description, isPublic, files: accepted });
      loadFolderTree();
    } else if (file) {
      if (!isAllowedFile(file.name)) { showToast('File type not allowed: ' + file.name); return; }
      const fd2 = new FormData();
      fd2.append('session', ses);
      fd2.append('department', dep);
      if (folderId) fd2.append('folder', folderId);
      if (cat) fd2.append('category', cat);
      if (description) fd2.append('description', description);
      fd2.append('file', file);
      fd2.append('is_public', isPublic);
      
      try {
        const up = await fetch('/api/files/', { method: 'POST', body: fd2, headers: { 'X-CSRFToken': getCsrf() } });
        const json2 = await up.json();
        if (!up.ok) {
          alert('Upload failed: ' + (json2.detail || JSON.stringify(json2)));
          return;
        }
        alert('File uploaded successfully!');
        loadFolderTree();
      } catch (error) {
        alert('Error uploading file');
      }
    }
    
    // Reset form
    document.getElementById('upload-form').reset();
  });

  async function uploadEntireFolder({ ses, dep, cat, parent, description, isPublic, files }) {
    // Map of relative folder path -> folderId
    const folderIdByPath = new Map();
    const rootParentId = parent || null;

    // Ensure root parent id mapping
    folderIdByPath.set('', rootParentId);

    // First pass: create all needed folders
    const folderPaths = new Set();
    for (const f of files) {
      const relPath = f.webkitRelativePath || f.name; // e.g., FolderA/sub/file.txt
      const parts = relPath.split('/');
      parts.pop(); // remove file name
      let pathAcc = '';
      for (const part of parts) {
        pathAcc = pathAcc ? `${pathAcc}/${part}` : part;
        folderPaths.add(pathAcc);
      }
    }

    // Sort folder paths shallow to deep to ensure parents exist
    const sortedPaths = Array.from(folderPaths).sort((a, b) => a.split('/').length - b.split('/').length);

    for (const path of sortedPaths) {
      if (folderIdByPath.has(path)) continue;
      const segments = path.split('/');
      const name = segments[segments.length - 1];
      const parentPath = segments.slice(0, -1).join('/');
      const parentId = folderIdByPath.get(parentPath) || null;

      const fd = new FormData();
      fd.append('session', ses);
      fd.append('department', dep);
      fd.append('name', name);
      if (parentId) fd.append('parent', parentId);
      if (cat) fd.append('category', cat);
      if (description) fd.append('description', description);
      fd.append('is_public', isPublic);

      const res = await fetch('/api/folders/', { method: 'POST', body: fd, headers: { 'X-CSRFToken': getCsrf() } });
      const json = await res.json();
      if (!res.ok) {
        alert('Folder create failed for ' + path + ': ' + (json.detail || JSON.stringify(json)));
        throw new Error('Folder create failed');
      }
      folderIdByPath.set(path, json.id);
    }

    // Second pass: upload all files to their folder ids
    for (const f of files) {
      const relPath = f.webkitRelativePath || f.name;
      const folderPath = relPath.split('/').slice(0, -1).join('/');
      const targetFolderId = folderIdByPath.get(folderPath) || rootParentId;

      const fd2 = new FormData();
      fd2.append('session', ses);
      fd2.append('department', dep);
      if (targetFolderId) fd2.append('folder', targetFolderId);
      if (cat) fd2.append('category', cat);
      if (description) fd2.append('description', description);
      fd2.append('file', f);
      fd2.append('is_public', isPublic);

      const up = await fetch('/api/files/', { method: 'POST', body: fd2, headers: { 'X-CSRFToken': getCsrf() } });
      if (!up.ok) {
        const j = await up.json().catch(() => ({ detail: 'Unknown error' }));
        const msg = j.detail || JSON.stringify(j);
        if (String(msg).toLowerCase().includes('not allowed')) { showToast('Upload failed for ' + relPath + ': ' + msg); } else { alert('Upload failed for ' + relPath + ': ' + msg); }
        throw new Error('File upload failed');
      }
    }
  }

  // Create Folder button
  document.getElementById('create-folder-btn').addEventListener('click', async () => {
    const ses = document.getElementById('session').value;
    const dep = document.getElementById('department').value;
    const cat = document.getElementById('category').value;
    const parent = document.getElementById('parent').value;
    const folderName = document.getElementById('folder-name').value.trim();
    const description = document.getElementById('description').value;
    const isPublic = document.getElementById('visibility-public').checked;

    if (!ses || !dep) { alert('Select session and department'); return; }
    if (!folderName) { alert('Enter a folder name'); return; }

    const fd = new FormData();
    fd.append('session', ses);
    fd.append('department', dep);
    fd.append('name', folderName);
    if (parent) fd.append('parent', parent);
    if (cat) fd.append('category', cat);
    if (description) fd.append('description', description);
    fd.append('is_public', isPublic);

    try {
      const res = await fetch('/api/folders/', { method: 'POST', body: fd, headers: { 'X-CSRFToken': getCsrf() } });
      const json = await res.json();
      if (!res.ok) { alert('Folder create failed: ' + (json.detail || JSON.stringify(json))); return; }
      alert('Folder created successfully!');
      document.getElementById('folder-name').value = '';
      loadFolderTree();
    } catch (e) {
      alert('Error creating folder');
    }
  });
  
  // Search on Enter key
  document.getElementById('search-input').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      performSearch();
    }
  });
  
  init();
  if (location.hash === '#profile') { openProfilePanel(); }
  window.addEventListener('hashchange', () => { if (location.hash === '#profile') openProfilePanel(); });

  function showFloatingMenuFrom(sourceEl, anchorBtn) {
    let fm = document.getElementById('floating-menu');
    if (!fm) {
      fm = document.createElement('div');
      fm.id = 'floating-menu';
      fm.className = 'fixed bg-white border rounded shadow z-[99999]';
      document.body.appendChild(fm);
    }
    // Copy menu content
    fm.innerHTML = sourceEl.innerHTML;
    fm.style.display = 'block';
    fm.classList.remove('hidden');
    // Size and position next to the anchor button
    const rect = anchorBtn.getBoundingClientRect();
    // Ensure minimum width similar to w-36 (9rem)
    fm.style.minWidth = '9rem';
    fm.style.maxWidth = '16rem';
    fm.style.left = Math.max(8, rect.right - 144) + 'px'; // align right edges roughly
    fm.style.top = (rect.bottom + 6) + 'px';
  }
</script>
{% endblock %}
