{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}{{ block.super }}
<style>
  /* Layout */
  .cards{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}

  /* Cards */
  .card{background:#fff;border-radius:14px;padding:18px;border:1px solid var(--mits-border);
        box-shadow:0 1px 2px rgba(2,6,23,.04);transition:transform .15s ease, box-shadow .15s ease}
  .card:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(2,6,23,.08)}
  .card h3{margin:0 0 6px;font-size:12px;color:var(--mits-muted);text-transform:uppercase;letter-spacing:.04em}
  .card .num{font-size:28px;font-weight:700;color:var(--mits-text);margin-top:2px}
  .card .hint{font-size:12px;color:var(--mits-muted)}

  /* Panels */
  .panel{background:#fff;border:1px solid var(--mits-border);border-radius:14px;overflow:hidden;
         box-shadow:0 1px 2px rgba(2,6,23,.04)}
  .panel-header{display:flex;align-items:center;justify-content:space-between;gap:12px;
                padding:14px 16px;border-bottom:1px solid var(--mits-border);
                font-weight:600;color:var(--mits-text)}
  .panel-actions a{font-size:12px;color:var(--mits-primary);text-decoration:none}
  .panel-actions a:hover{text-decoration:underline}
  .panel-body{padding:14px 16px}

  /* Activity */
  .activity-item{display:flex;justify-content:space-between;gap:12px;border-bottom:1px solid #f1f5f9;padding:10px 0}
  .activity-item:last-child{border-bottom:0}
  .activity-item .file{color:var(--mits-muted)}
  .activity-item .time{color:var(--mits-muted);white-space:nowrap}

  /* Header actions */
  .quick-actions{display:flex;flex-wrap:wrap;gap:8px}
  .qa-btn{display:inline-flex;align-items:center;gap:8px;background:var(--mits-accent);border:1px solid var(--mits-accent);
          color:#fff!important;border-radius:10px;padding:8px 12px;text-decoration:none;box-shadow:0 1px 2px rgba(2,6,23,.06);
          transition:background .15s ease, transform .12s ease}
  .qa-btn:hover{background:#2563eb;transform:translateY(-1px)}
  .qa-btn svg{width:16px;height:16px;fill:#fff}

  /* Containers */
  .container-max{max-width:1200px}
</style>
{% endblock %}

{% block content %}
<div id="content-main" class="container-max">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
    <h1 style="margin:0;color:var(--mits-text)">MITS Portal Admin Dashboard</h1>
    <div class="quick-actions">
      <a href="/admin/storage/department/add/" class="qa-btn" title="Add Department">
        <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
        Add Department
      </a>
      <a href="/admin/storage/academicsession/add/" class="qa-btn" title="Add Session">
        <svg viewBox="0 0 24 24"><path d="M7 11h10M7 7h10M7 15h6"/></svg>
        Add Session
      </a>
      <a href="/admin/auth/user/add/" class="qa-btn" title="Add User">
        <svg viewBox="0 0 24 24"><path d="M16 14c2.21 0 4 1.79 4 4v2H4v-2c0-2.21 1.79-4 4-4m8-6a4 4 0 11-8 0 4 4 0 018 0"/></svg>
        Add User
      </a>
    </div>
  </div>

  <div class="cards" style="margin-bottom:16px" id="admin-cards">
    <div class="card"><h3>Users</h3><div class="num" id="stat-users">—</div></div>
    <div class="card"><h3>Sessions</h3><div class="num" id="stat-sessions">—</div></div>
    <div class="card"><h3>Departments</h3><div class="num" id="stat-departments">—</div></div>
    <div class="card"><h3>Folders</h3><div class="num" id="stat-folders">—</div></div>
    <div class="card"><h3>Files</h3><div class="num" id="stat-files">—</div></div>
    <div class="card"><h3>Share Links</h3><div class="num" id="stat-sharelinks">—</div></div>
    <div class="card"><h3>Notifications</h3><div class="num" id="stat-notifications">—</div></div>
    <div class="card"><h3>Storage Used</h3><div class="num" id="stat-storage">—</div><div class="hint" id="stat-storage-bytes"></div></div>
  </div>

  <div class="panel" style="margin-bottom:16px">
    <div class="panel-header">
      <span>Recent Activity</span>
      <span class="panel-actions"><a href="/admin/storage/fileauditlog/">View all</a></span>
    </div>
    <div class="panel-body" id="recent-activity"></div>
  </div>

  <div class="panel" style="margin-bottom:16px">
    <div class="panel-header">Uploads per day</div>
    <div class="panel-body">
      <canvas id="chart-uploads" height="120"></canvas>
    </div>
  </div>

  <div class="panel" style="margin-bottom:16px">
    <div class="panel-header">Files by department</div>
    <div class="panel-body">
      <canvas id="chart-dept" height="120"></canvas>
    </div>
  </div>

  {{ block.super }}
</div>
<script>
  (async function(){
    try{
      const [statsRes, recentRes] = await Promise.all([
        fetch('/api/admin/stats/', {credentials:'same-origin'}),
        fetch('/api/admin/recent/', {credentials:'same-origin'})
      ]);
      if(statsRes.ok){
        const s = await statsRes.json();
        for(const k of Object.keys(s)){
          const el = document.getElementById('stat-' + k);
          if(el) el.textContent = s[k];
        }
        // Optional: show raw bytes as hint if provided
        if (s.storage_bytes !== undefined) {
          const hint = document.getElementById('stat-storage-bytes');
          if (hint) hint.textContent = `(${s.storage_bytes} bytes)`;
        }
      }
      if(recentRes.ok){
        const data = await recentRes.json();
        const root = document.getElementById('recent-activity');
        if(data.logs && data.logs.length){
          root.innerHTML = data.logs.map(l=>`
            <div class="activity-item">
              <div><strong>${l.user}</strong> ${l.action} <span class="file">${l.file}</span></div>
              <div class="time">${l.timestamp}</div>
            </div>
          `).join('');
        } else {
          root.textContent = 'No recent activity.';
        }
      }
    }catch(e){/* ignore */}
  })();

  // Load charts
  (async function(){
    try{
      const [upRes, deptRes] = await Promise.all([
        fetch('/api/admin/charts/uploads-per-day/', {credentials:'same-origin'}),
        fetch('/api/admin/charts/files-by-department/', {credentials:'same-origin'})
      ]);
      const [up, dept] = await Promise.all([upRes.json(), deptRes.json()]);
      const ctx1 = document.getElementById('chart-uploads').getContext('2d');
      const ctx2 = document.getElementById('chart-dept').getContext('2d');
      // Lazy load Chart.js
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
      s.onload = function(){
        new Chart(ctx1, { type:'line', data:{ labels: up.labels, datasets:[{ label:'Uploads', data: up.data, borderColor:'#1e3a8a', backgroundColor:'rgba(30,58,138,0.1)', tension:0.25, fill:true }] }, options:{ plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true }}}});
        new Chart(ctx2, { type:'bar', data:{ labels: dept.labels, datasets:[{ label:'Files', data: dept.data, backgroundColor:'#0ea5e9' }] }, options:{ plugins:{legend:{display:false}}, indexAxis:'y', scales:{ x:{ beginAtZero:true }}}});
      };
      document.body.appendChild(s);
    }catch(e){/* ignore */}
  })();
</script>
{% endblock %}


